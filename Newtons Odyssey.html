<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newton's Odyssey: Master Edition</title>
    <style>
        :root {
            --bg: #0b0f19;
            --panel: #151e2e;
            --primary: #00d4ff;
            --accent: #ff0055;
            --success: #00ff9d;
            --warning: #f59e0b;
            --text: #e0e6ed;
            --border: #2a3b55;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .app-wrapper {
            max-width: 1000px;
            height: 100vh;
            margin: 0 auto;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        header {
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-weight: 900; letter-spacing: 2px; color: var(--primary); text-transform: uppercase; }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .score-box {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--warning);
            border: 1px solid var(--warning);
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* Dev Mode UI */
        .settings-icon { cursor: pointer; font-size: 1.2rem; color: #555; transition: 0.3s; }
        .settings-icon:hover { color: white; transform: rotate(90deg); }
        .dev-bar { display: none; gap: 5px; margin-right: 10px; }
        .dev-btn { 
            background: #333; color: var(--primary); border: 1px solid var(--primary); 
            padding: 2px 8px; cursor: pointer; font-size: 0.8rem; border-radius: 4px; 
            font-family: monospace; font-weight: bold;
        }
        .dev-btn:hover { background: var(--primary); color: black; }

        .stage-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .section { display: none; animation: fadeUp 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { border-left: 4px solid var(--primary); padding-left: 10px; margin-top: 0; color: white; }
        h3 { color: #cbd5e1; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 20px;}
        p { color: #94a3b8; line-height: 1.5; }

        /* --- UI COMPONENTS --- */
        .btn {
            background: var(--success); color: black; border: none; padding: 12px 24px;
            border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem;
            width: 100%; margin-top: 10px; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,255,157,0.2);
            transition: transform 0.1s;
        }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; box-shadow: none; }
        .btn:active { transform: translateY(2px); }

        .input-group {
            margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; text-align: center; display: none;
        }
        input.code-box {
            background: #000; border: 1px solid var(--primary); color: white;
            padding: 10px; text-align: center; text-transform: uppercase; letter-spacing: 2px;
            font-size: 1.2rem; border-radius: 4px; width: 200px;
        }

        /* --- PAGE 1: DROPDOWNS --- */
        .def-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .def-row { 
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; 
        }
        .def-text { font-size: 0.95rem; color: #fff; flex: 1; margin-right: 15px; }
        select.def-select {
            background: #000; color: var(--primary); border: 1px solid #444;
            padding: 8px; border-radius: 4px; width: 150px; font-weight: bold;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #000; }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: center; }
        th { color: var(--primary); }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--success); }

        /* --- PAGE 2: ROCKET --- */
        .rocket-ui { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #000; padding: 20px; border-radius: 12px; }
        .rocket-viz { height: 300px; border: 1px solid #333; border-radius: 8px; position: relative; overflow: hidden; background: linear-gradient(to bottom, #000 0%, #1a237e 100%); }
        #rocket-svg { transition: transform 1s ease; }
        .booster { transition: transform 2s ease-out, opacity 1s; }
        .booster.detached-left { transform: translate(-50px, 100px) rotate(-45deg); opacity: 0; }
        .booster.detached-right { transform: translate(50px, 100px) rotate(45deg); opacity: 0; }

        /* --- PAGE 3 & 4: QUIZ CARDS --- */
        .quiz-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border-left: 3px solid var(--accent);
        }
        .quiz-opt {
            display: block; background: rgba(0,0,0,0.3); margin: 5px 0; padding: 10px; border-radius: 4px;
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .quiz-opt:hover { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .quiz-opt.selected { background: var(--primary); color: black; border-color: var(--primary); font-weight: bold; }
        .quiz-opt.wrong { background: var(--accent); color: white; opacity: 0.5; }

        /* --- PAGE 5: LANDER TABS --- */
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tab-btn {
            background: transparent; border: none; color: #888; padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 1rem;
            border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .tab-btn:hover { color: white; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .tab-content { display: none; animation: fadeUp 0.2s; }
        .tab-content.active { display: block; }

        .planet-selector, .rocket-selector { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .p-btn { flex: 1; padding: 10px; background: #333; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; font-size: 0.9rem;}
        .p-btn.active { background: var(--primary); color: black; font-weight: bold; border-color: var(--primary); }

        /* CANVAS */
        canvas { background: #000; width: 100%; height: 400px; border-radius: 8px; border: 2px solid #333; display: block; }
        
        /* DATA & HINTS */
        .data-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;
            display: grid; grid-template-columns: 1fr 1fr; gap:10px; font-family: monospace; font-size: 1rem;
        }
        .warning-box {
            border: 1px solid var(--accent); background: rgba(255, 0, 85, 0.1); color: var(--accent);
            padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px;
        }
        .hint-box {
            display: none; background: #333; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.9rem; color: #ccc;
        }

    </style>
</head>
<body>

<div class="app-wrapper">
    <header>
        <div class="logo">Newton's Odyssey</div>
        <div class="header-controls">
            <div id="score-display" class="score-box">Score: 0</div>
            <!-- Dev Mode Controls -->
            <div id="dev-bar" class="dev-bar">
                <button class="dev-btn" onclick="jumpTo(1)">1</button>
                <button class="dev-btn" onclick="jumpTo(2)">2</button>
                <button class="dev-btn" onclick="jumpTo(3)">3</button>
                <button class="dev-btn" onclick="jumpTo(4)">4</button>
                <button class="dev-btn" onclick="jumpTo(5)">5</button>
            </div>
            <div class="settings-icon" title="Dev Mode" onclick="activateDevMode()">⚙️</div>
        </div>
    </header>

    <div class="stage-area">

        <!-- PAGE 1: DEFINITIONS (DROPDOWNS) -->
        <div class="section active" id="page1">
            <h2>Stage 1: Force Classification</h2>
            <p><strong>Task:</strong> Select the correct term for each definition. 100% accuracy required.</p>

            <div class="def-list">
                <div class="def-row"><span class="def-text">Force of gravity pulling down</span>
                    <select id="def1" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="def-row"><span class="def-text">Opposes motion between touching surfaces</span>
                    <select id="def2" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="def-row"><span class="def-text">Drag force in the atmosphere (Air)</span>
                    <select id="def3" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="def-row"><span class="def-text">Unit of measurement for Force</span>
                    <select id="def4" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="def-row"><span class="def-text">Upward force in water</span>
                    <select id="def5" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="def-row"><span class="def-text">Forces that cause acceleration/change shape</span>
                    <select id="def6" class="def-select">
                        <option value="">Select...</option>
                        <option value="air">Air Resistance</option>
                        <option value="friction">Friction</option>
                        <option value="newton">Newton</option>
                        <option value="unbalanced">Unbalanced</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
            </div>

            <h3>Contact vs Non-Contact</h3>
            <table>
                <tr><th>Force</th><th>Contact</th><th>Non-Contact</th></tr>
                <tr><td>Friction</td><td><input type="checkbox" id="c1"></td><td><input type="checkbox" id="nc1"></td></tr>
                <tr><td>Magnetic</td><td><input type="checkbox" id="c2"></td><td><input type="checkbox" id="nc2"></td></tr>
                <tr><td>Electrostatic</td><td><input type="checkbox" id="c3"></td><td><input type="checkbox" id="nc3"></td></tr>
                <tr><td>Tension</td><td><input type="checkbox" id="c4"></td><td><input type="checkbox" id="nc4"></td></tr>
            </table>

            <button class="btn" id="p1-btn" onclick="checkPage1()">Submit Database</button>
            <div id="p1-msg" style="text-align:center; margin-top:10px; font-weight:bold;"></div>

            <div class="input-group" id="p1-lock">
                <p>Access Granted. Code: <strong style="color:var(--success)">NEWTON</strong></p>
                <input type="text" class="code-box" id="code1" placeholder="ENTER CODE">
                <button class="btn" onclick="unlockPage(1, 'NEWTON')">Proceed to Launchpad</button>
            </div>
        </div>

        <!-- PAGE 2: ROCKET -->
        <div class="section" id="page2">
            <h2>Stage 2: Launch Dynamics</h2>
            <div class="rocket-ui">
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <p id="mission-text" style="color:var(--primary); font-weight:bold; min-height:60px;">
                        MISSION 1: Rocket Weight is 5000N. NASA wants to ACCELERATE. Adjust thrust!
                    </p>
                    <div style="background:#222; padding:15px; border-radius:8px;">
                        <label>Rocket Weight: <span id="r-weight">5000</span> N</label><br><br>
                        <label>Thrust: <span id="r-thrust-val">0</span> N</label>
                        <input type="range" id="thrust-slider" min="0" max="10000" step="500" value="0" oninput="updateRocketViz()" style="width:100%; accent-color:var(--primary);">
                    </div>
                    <button class="btn" onclick="checkRocketMission()">Execute Command</button>
                    <div id="rocket-msg" style="text-align:center; margin-top:10px; font-weight:bold; min-height:20px;"></div>
                </div>

                <div class="rocket-viz">
                    <svg id="rocket-svg" width="100%" height="100%" viewBox="0 0 200 300" style="overflow:visible">
                        <g transform="translate(100, 200)">
                            <rect x="-20" y="-60" width="40" height="100" fill="#e2e8f0" stroke="#333" />
                            <path d="M-20 -60 L0 -100 L20 -60 Z" fill="#e2e8f0" stroke="#333" />
                            <g id="booster-left" class="booster"><path d="M-35 -30 L-20 -30 L-20 40 L-35 40 Z" fill="#cbd5e1" stroke="#333"/></g>
                            <g id="booster-right" class="booster"><path d="M20 -30 L35 -30 L35 40 L20 40 Z" fill="#cbd5e1" stroke="#333"/></g>
                            <path id="main-flame" d="M-15 40 L0 40 L15 40 Z" fill="orange" opacity="0" />
                        </g>
                    </svg>
                </div>
            </div>

            <div class="input-group" id="p2-lock">
                <p>Orbit Achieved. Code: <strong style="color:var(--success)">APOLLO</strong></p>
                <input type="text" class="code-box" id="code2" placeholder="ENTER CODE">
                <button class="btn" onclick="unlockPage(2, 'APOLLO')">Begin Re-entry</button>
            </div>
        </div>

        <!-- PAGE 3: AIR RESISTANCE & REACTION (QUIZ CARDS) -->
        <div class="section" id="page3">
            <h2>Stage 3: Atmosphere Re-entry</h2>
            <p>Select the correct answer to guide the capsule.</p>

            <div class="quiz-card" id="card-q3-1">
                <p><strong>Fact:</strong> Air resistance is a contact force caused by colliding with air particles.</p>
                <p>Q1: As the capsule speeds up falling through air, what happens to Air Resistance?</p>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-1')">It decreases</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'correct', 'q3-1')">It increases</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-1')">It stays the same</div>
            </div>

            <div class="quiz-card" id="card-q3-2">
                <p><strong>Fact:</strong> Terminal Velocity is when the forces on a falling object are BALANCED.</p>
                <p>Q2: At Terminal Velocity, the speed is...</p>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-2')">Accelerating</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'correct', 'q3-2')">Constant</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-2')">Zero</div>
            </div>

            <div class="quiz-card" id="card-q3-3">
                <p><strong>Fact:</strong> Newton's 3rd Law: For every action, there is an equal and opposite reaction.</p>
                <p>Q3: A book sits on a table. Gravity pulls it down. What force pushes it up?</p>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-3')">Friction</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'wrong', 'q3-3')">Upthrust</div>
                <div class="quiz-opt" onclick="selQuiz(this, 'correct', 'q3-3')">Reaction</div>
            </div>
            
            <div class="input-group" style="display:block">
                <p>The answer to Question 3 is your Code.</p>
                <input type="text" class="code-box" id="code3" placeholder="ANSWER Q3">
                <button class="btn" onclick="unlockPage(3, 'REACTION')">Splashdown</button>
            </div>
        </div>

        <!-- PAGE 4: BOAT & UPTHRUST (QUIZ CARDS) -->
        <div class="section" id="page4">
            <h2>Stage 4: Recovery</h2>
            <p><strong>Challenge:</strong> Stabilize the capsule so it floats.</p>
            <div style="background:linear-gradient(to bottom, #87ceeb 50%, #1e3a8a 50%); height:200px; border-radius:8px; text-align:center; position:relative;">
                <svg width="100%" height="100%" viewBox="0 0 200 200">
                    <g id="boat-group" transform="translate(100, 110)">
                        <path id="hull-shape" d="M-20 0 L-10 30 L10 30 L20 0 Z" fill="#94a3b8" stroke="black" />
                        <text x="-15" y="20" font-size="10">CAPSULE</text>
                    </g>
                </svg>
            </div>
            <input type="range" id="width-slider" min="20" max="80" value="20" oninput="updateBoat()" style="width:100%; margin-top:20px; accent-color:var(--primary)">
            <p id="boat-status" style="text-align:center; font-weight:bold; color:var(--accent)">SINKING</p>

            <div class="quiz-card" style="margin-top:30px;" id="card-q4-1">
                <p>Q1: To float, the Upthrust must be...</p>
                <div class="quiz-opt" onclick="selQuizBoat(this, 'wrong', 'q4-1')">Less than Weight</div>
                <div class="quiz-opt" onclick="selQuizBoat(this, 'correct', 'q4-1')">Equal to or bigger than Weight</div>
            </div>

            <div class="quiz-card" id="card-q4-2">
                <p>Q2: Upthrust is caused by...</p>
                <div class="quiz-opt" onclick="selQuizBoat(this, 'wrong', 'q4-2')">The material of the boat</div>
                <div class="quiz-opt" onclick="selQuizBoat(this, 'correct', 'q4-2')">Displacing (pushing aside) water particles</div>
            </div>

            <!-- New Question Block -->
            <div class="quiz-card">
                <p><strong>Analysis:</strong> Complete the sentence.</p>
                <p>In the above activity, we are changing the 
                    <select id="q4-d1" class="def-select" style="width:auto; display:inline-block;">
                        <option value="">...</option>
                        <option value="floatiness">Floatiness</option>
                        <option value="area">Surface Area</option>
                        <option value="weight">Weight</option>
                        <option value="temp">Temperature</option>
                    </select> 
                    of the boat to increase the 
                    <select id="q4-d2" class="def-select" style="width:auto; display:inline-block;">
                        <option value="">...</option>
                        <option value="gravity">Gravity</option>
                        <option value="water">Water</option>
                        <option value="upthrust">Upthrust</option>
                        <option value="friction">Friction</option>
                    </select>.
                </p>
            </div>

            <button class="btn" id="boat-btn" onclick="finishBoat()" disabled>Stabilize</button>
            <div id="boat-error" style="color:var(--accent); text-align:center; margin-top:5px;"></div>
        </div>

        <!-- PAGE 5: LANDER -->
        <div class="section" id="page5">
            <h2>Final Exam: Planetary Landing</h2>
            
            <div class="planet-selector">
                <button class="p-btn active" onclick="setPlanet('moon')">Moon</button>
                <button class="p-btn" onclick="setPlanet('mars')">Mars</button>
                <button class="p-btn" onclick="setPlanet('earth')">Earth</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('pilot')">Pilot Mode</button>
                <button class="tab-btn" onclick="openTab('engineer')">Engineer</button>
                <button class="tab-btn" onclick="openTab('physicist')">Physicist</button>
            </div>

            <!-- PILOT MODE (Code 6 Engine) -->
            <div id="tab-pilot" class="tab-content active">
                <p><strong>Instructions:</strong> Use SPACEBAR or TAP screen to thrust. Land gently (Velocity < 2).</p>
                <div style="display:flex; justify-content:space-between; font-family:monospace; margin-bottom:5px; font-weight:bold;">
                    <span>FUEL: <span id="ui-fuel" style="color:var(--primary)">100</span></span>
                    <span style="color:var(--warning)">BEST SCORE: <span id="pilot-high-score">0</span></span>
                </div>
                <canvas id="gameCanvas" height="400"></canvas>
                <button class="btn" onclick="resetGame()">Begin Landing</button>
            </div>

            <!-- ENGINEER MODE -->
            <div id="tab-engineer" class="tab-content">
                <div class="data-card">
                    <span>Mass: 100 kg</span>
                    <span>Gravity: <span class="g-disp">1.6</span> m/s²</span>
                </div>
                <p>Calculate the <strong>Thrust (N)</strong> required to <strong>HOVER</strong> perfectly still.</p>
                <input type="number" id="eng-input" class="code-box" placeholder="Enter Thrust (N)">
                <button class="btn" onclick="checkEngineer()">Submit Answer</button>
                <div id="eng-msg" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
            </div>

            <!-- PHYSICIST MODE -->
            <div id="tab-physicist" class="tab-content">
                <div class="warning-box">
                    WARNING: Extreme difficulty. Requires Suicide Burn calculation.
                </div>
                
                <div class="rocket-selector">
                    <button class="p-btn active" onclick="setRocket('A')">Eagle (1000kg/3600N)</button>
                    <button class="p-btn" onclick="setRocket('B')">Kestrel (1500kg/6000N)</button>
                    <button class="p-btn" onclick="setRocket('C')">Falcon (2500kg/25000N)</button>
                </div>

                <div class="data-card" style="grid-template-columns: 1fr 1fr; font-size: 0.9rem;">
                    <span>Mass: <span id="phy-m">1000</span>kg</span>
                    <span>Thrust: <span id="phy-t">3600</span>N</span>
                    <span>Gravity: <span class="g-disp">1.6</span> m/s²</span>
                    <span>Approach: <strong><span id="phy-v">40</span>m/s</strong></span>
                </div>
                
                <div id="phy-status" style="text-align:center; margin-bottom:10px; font-weight:bold; color:var(--success)">SYSTEM READY</div>

                <p>Calculate the <strong>Burn Altitude (m)</strong>. Engines must fire at this exact height to reach 0 m/s exactly at ground level.</p>
                
                <input type="number" id="phys-input" class="code-box" placeholder="Altitude (m)">
                <button id="sim-btn" class="btn" style="background:var(--accent); color:white" onclick="runSimulation()">Begin Simulation</button>
                <button class="btn" style="background:#444; margin-top:5px;" onclick="toggleHint()">Show Equations (Hint)</button>
                
                <div id="math-hint" class="hint-box">
                    <p>1. Weight $W = m \times g$</p>
                    <p>2. Net Force $F_{net} = Thrust - W$</p>
                    <p>3. Deceleration $a_{net} = F_{net} / m$</p>
                    <p>4. Burn Altitude $h = v_0^2 / (2 \times a_{net})$</p>
                    <p>5. Burn Time $t = v_0 / a_{net}$</p>
                </div>

                <!-- Simulation Canvas -->
                <canvas id="simCanvas" height="400" style="margin-top:20px; border-color:var(--accent)"></canvas>
            </div>

        </div>

    </div>
</div>

<script>
    /* --- SCORING SYSTEM --- */
    let globalScore = 0;
    
    // Track attempt counts for partial credit
    let scoreState = {
        p1Attempts: 0, p1Done: false,
        p2Done: false,
        q3: { "q3-1": {atts:0, done:false}, "q3-2": {atts:0, done:false}, "q3-3": {atts:0, done:false} },
        q4: { "q4-1": {atts:0, done:false}, "q4-2": {atts:0, done:false} },
        q4SentenceAttempts: 0, q4SentenceDone: false,
        pilotHigh: 0
    };

    function updateScore(points) {
        globalScore += points;
        document.getElementById('score-display').innerText = "Score: " + globalScore;
    }

    function updatePilotHighScore(score) {
        if (score > scoreState.pilotHigh) {
            scoreState.pilotHigh = score;
            document.getElementById('pilot-high-score').innerText = scoreState.pilotHigh;
        }
    }

    /* --- DEV MODE --- */
    function activateDevMode() {
        const pwd = prompt("Enter Developer Password:");
        if(pwd === "MrSorrell") {
            document.getElementById('dev-bar').style.display = 'flex';
            document.querySelector('.settings-icon').style.color = 'var(--success)';
            alert("Dev Mode Enabled. Use the top bar to navigate.");
        } else {
            alert("Access Denied.");
        }
    }

    function jumpTo(pageId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('page'+pageId).classList.add('active');
        if(pageId === 5) {
            setTimeout(initPilotCanvas, 100);
            setTimeout(initSimCanvas, 100);
            updatePhysicistUI();
        }
    }

    /* --- PAGE 1 LOGIC (DROPDOWNS) --- */
    function checkPage1() {
        if(scoreState.p1Done) return; // Prevent double submit

        const d1 = document.getElementById('def1').value === 'weight';
        const d2 = document.getElementById('def2').value === 'friction';
        const d3 = document.getElementById('def3').value === 'air';
        const d4 = document.getElementById('def4').value === 'newton';
        const d5 = document.getElementById('def5').value === 'upthrust';
        const d6 = document.getElementById('def6').value === 'unbalanced';

        const c1 = document.getElementById('c1').checked; // Fric - C
        const nc2 = document.getElementById('nc2').checked; // Mag - NC
        const nc3 = document.getElementById('nc3').checked; // Elec - NC
        const c4 = document.getElementById('c4').checked; // Ten - C
        
        const incorrect = document.getElementById('nc1').checked || document.getElementById('c2').checked || document.getElementById('c3').checked || document.getElementById('nc4').checked;

        if(d1 && d2 && d3 && d4 && d5 && d6 && c1 && nc2 && nc3 && c4 && !incorrect) {
            document.getElementById('p1-msg').innerText = "100% CORRECT.";
            document.getElementById('p1-msg').style.color = "var(--success)";
            document.getElementById('p1-lock').style.display = "block";
            
            // Scoring Logic
            let pts = 0;
            if(scoreState.p1Attempts === 0) pts = 100;
            else if(scoreState.p1Attempts === 1) pts = 50;
            else pts = 25;
            
            updateScore(pts);
            scoreState.p1Done = true;
            document.getElementById('p1-btn').disabled = true;

        } else {
            document.getElementById('p1-msg').innerText = "INCORRECT. Check Dropdowns and Checkboxes.";
            document.getElementById('p1-msg').style.color = "var(--accent)";
            scoreState.p1Attempts++;
        }
    }

    function unlockPage(pg, code) {
        if(document.getElementById('code'+pg).value.toUpperCase().trim() === code) {
            document.getElementById('page'+pg).classList.remove('active');
            document.getElementById('page'+(pg+1)).classList.add('active');
            if(pg+1 === 5) {
                setTimeout(initPilotCanvas, 100);
            }
        } else { alert("WRONG CODE"); }
    }

    /* --- PAGE 2 LOGIC --- */
    let missionStage = 1;
    function updateRocketViz() {
        const t = parseInt(document.getElementById('thrust-slider').value);
        document.getElementById('r-thrust-val').innerText = t;
        const flame = document.getElementById('main-flame');
        if(t > 0) { flame.setAttribute('opacity', 1); flame.setAttribute('d', `M-15 40 L0 ${40+t/50} L15 40 Z`); } 
        else { flame.setAttribute('opacity', 0); }
    }

    function checkRocketMission() {
        const t = parseInt(document.getElementById('thrust-slider').value);
        const w = parseInt(document.getElementById('r-weight').innerText);
        const msg = document.getElementById('rocket-msg');
        const txt = document.getElementById('mission-text');

        if(missionStage === 1 && t > w) {
            msg.innerText = "ACCELERATING!"; msg.style.color="var(--success)";
            setTimeout(() => { missionStage=2; txt.innerText="MISSION 2: Stabilize Speed (Constant)."; msg.innerText=""; }, 2000);
        } else if(missionStage === 2 && t === w) {
            msg.innerText = "STABLE."; msg.style.color="var(--success)";
            setTimeout(() => { 
                missionStage=3; txt.innerText="MISSION 3: Stage Separation! Weight Dropping."; msg.innerText=""; 
                document.getElementById('booster-left').classList.add('detached-left');
                document.getElementById('booster-right').classList.add('detached-right');
                document.getElementById('r-weight').innerText="2000";
            }, 2000);
        } else if(missionStage === 3 && t === 2000) {
            msg.innerText = "STABLE."; msg.style.color="var(--success)";
            setTimeout(() => { missionStage=4; txt.innerText="FINAL: Slow Down!"; msg.innerText=""; }, 2000);
        } else if(missionStage === 4 && t < 2000 && t > 0) {
            msg.innerText = "DECELERATING. DONE."; msg.style.color="var(--success)";
            document.getElementById('p2-lock').style.display="block";
            
            if(!scoreState.p2Done) {
                updateScore(50);
                scoreState.p2Done = true;
            }

        } else {
            msg.innerText = "INCORRECT THRUST."; msg.style.color="var(--accent)";
        }
    }

    /* --- PAGE 3 & 4 LOGIC (Quiz Cards) --- */
    function selQuiz(el, type, qId) {
        // Visuals
        const parent = el.parentNode;
        const siblings = parent.querySelectorAll('.quiz-opt');
        siblings.forEach(s => { s.classList.remove('selected'); s.classList.remove('wrong'); });
        
        let qState = scoreState.q3[qId]; // Assuming Q3 for now based on ID logic
        
        if(type === 'correct') {
            el.classList.add('selected');
            // Scoring Logic
            if(!qState.done) {
                let pts = 0;
                if(qState.atts === 0) pts = 20;
                else if(qState.atts === 1) pts = 10;
                else pts = 5;
                
                updateScore(pts);
                qState.done = true;
            }
        } else {
            el.classList.add('wrong');
            if(!qState.done) {
                qState.atts++;
            }
        }
    }

    function selQuizBoat(el, type, qId) {
        // Visuals
        const parent = el.parentNode;
        const siblings = parent.querySelectorAll('.quiz-opt');
        siblings.forEach(s => { s.classList.remove('selected'); s.classList.remove('wrong'); });

        let qState = scoreState.q4[qId];

        if(type === 'correct') {
            el.classList.add('selected');
             if(!qState.done) {
                let pts = 0;
                if(qState.atts === 0) pts = 20;
                else if(qState.atts === 1) pts = 10;
                else pts = 5;
                
                updateScore(pts);
                qState.done = true;
            }
        } else {
            el.classList.add('wrong');
            if(!qState.done) {
                qState.atts++;
            }
        }
    }

    function updateBoat() {
        const w = document.getElementById('width-slider').value;
        const hull = document.getElementById('hull-shape');
        hull.setAttribute('d', `M-${w} 0 L-${w*0.8} 30 L${w*0.8} 30 L${w} 0 Z`);
        if(w > 60) {
            document.getElementById('boat-status').innerText = "FLOATING";
            document.getElementById('boat-status').style.color="var(--success)";
            document.getElementById('boat-group').setAttribute('transform', 'translate(100, 90)');
            document.getElementById('boat-btn').disabled = false;
        } else {
            document.getElementById('boat-status').innerText = "SINKING";
            document.getElementById('boat-status').style.color="var(--accent)";
            document.getElementById('boat-group').setAttribute('transform', 'translate(100, 110)');
            document.getElementById('boat-btn').disabled = true;
        }
    }

    function finishBoat() {
        const selected = document.querySelectorAll('#page4 .quiz-opt.selected');
        const q4d1 = document.getElementById('q4-d1').value;
        const q4d2 = document.getElementById('q4-d2').value;
        
        const sentenceCorrect = (q4d1 === 'area' && q4d2 === 'upthrust');

        if(selected.length === 2 && sentenceCorrect) {
            
            // Sentence Scoring
            if(!scoreState.q4SentenceDone) {
                let pts = 0;
                if(scoreState.q4SentenceAttempts === 0) pts = 40;
                else pts = 20;
                updateScore(pts);
                scoreState.q4SentenceDone = true;
            }

            document.getElementById('page4').classList.remove('active');
            document.getElementById('page5').classList.add('active');
            // Init canvas
            setTimeout(initPilotCanvas, 100);
        } else {
            document.getElementById('boat-error').innerText = "Check your answers. Fill in the dropdowns correctly.";
            if(!sentenceCorrect) scoreState.q4SentenceAttempts++;
        }
    }

    /* --- PAGE 5: SHARED DATA --- */
    // CONSTANTS defined in prompt
    const planetData = {
        moon: { g: 1.6, v: 40, color: '#555' },
        mars: { g: 3.7, v: 60, color: '#c1440e' },
        earth: { g: 9.8, v: 120, color: '#10b981' }
    };

    const rocketData = {
        A: { name: 'Eagle', mass: 1000, thrust: 3600, type: 'tri' },
        B: { name: 'Kestrel', mass: 1500, thrust: 6000, type: 'squ' },
        C: { name: 'Falcon', mass: 2500, thrust: 25000, type: 'rect' }
    };
    
    let currentPlanet = 'moon';
    let currentRocket = rocketData.A;
    let currentGravity = planetData.moon.g;

    /* --- PAGE 5: PILOT GAME (Code 6 Logic) --- */
    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d');
    let ship = { x: 300, y: 50, vy: 0, vx: 0, fuel: 100, thrusting: false, active: false };
    
    function initPilotCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = cvs.getBoundingClientRect();
        cvs.width = rect.width * dpr;
        cvs.height = 400 * dpr; 
        ctx.scale(dpr, dpr);
    }

    // Input listeners
    document.addEventListener('keydown', e => { if(e.code==='Space') ship.thrusting=true; });
    document.addEventListener('keyup', e => { if(e.code==='Space') ship.thrusting=false; });
    cvs.addEventListener('mousedown', () => ship.thrusting=true);
    cvs.addEventListener('mouseup', () => ship.thrusting=false);
    cvs.addEventListener('touchstart', (e)=>{e.preventDefault(); ship.thrusting=true;});
    cvs.addEventListener('touchend', (e)=>{e.preventDefault(); ship.thrusting=false;});

    function setPlanet(p) {
        currentPlanet = p;
        currentGravity = planetData[p].g;
        document.querySelectorAll('.g-disp').forEach(el => el.innerText = currentGravity);
        document.querySelectorAll('.planet-selector .p-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // Update Physics Data
        updatePhysicistUI();
        resetGame();
    }

    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
        document.getElementById('tab-'+tabName).classList.add('active');
        event.target.classList.add('active');
        if(tabName === 'physicist') {
            setTimeout(initSimCanvas, 100);
            updatePhysicistUI();
        }
    }

    function resetGame() {
        initPilotCanvas();
        ship.y = 50; ship.vy = 0; ship.vx = (Math.random()-0.5); ship.fuel = 100;
        ship.x = (cvs.width / (window.devicePixelRatio||1)) / 2;
        ship.active = true;
        ship.startTime = Date.now();
        gameLoop();
    }

    function gameLoop() {
        if(!ship.active) return;
        
        // Physics (Code 6 logic - Smooth & Forgiving)
        ship.vy += (currentGravity * 0.02);
        if(ship.thrusting && ship.fuel > 0) {
            ship.vy -= 0.15; // Standard pilot thrust
            ship.fuel -= 0.3;
        }
        ship.x += ship.vx;
        ship.y += ship.vy;

        const W = cvs.width / (window.devicePixelRatio||1);
        const H = 400;

        // Draw
        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,W,H);
        // Ground
        ctx.fillStyle = planetData[currentPlanet].color;
        ctx.fillRect(0, 380, W, 20);
        ctx.fillStyle = "#fff"; // Pad
        ctx.fillRect(W/2 - 40, 380, 80, 5);

        // Ship
        ctx.save();
        ctx.translate(ship.x, ship.y);
        if(ship.thrusting && ship.fuel > 0) {
            ctx.fillStyle = "orange";
            ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(5, 10); ctx.lineTo(0, 25); ctx.fill();
        }
        ctx.fillStyle = "white";
        // Simple Triangle for Pilot Mode
        ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(10, 10); ctx.lineTo(-10, 10); ctx.fill();
        ctx.restore();

        // UI
        ctx.font = "16px monospace"; ctx.fillStyle = "white";
        document.getElementById('ui-fuel').innerText = Math.floor(ship.fuel);
        
        // Logic
        if(ship.y >= 370) {
            ship.active = false;
            // Success condition: Velocity < 2.0
            if(ship.vy < 2.0) {
                // Scoring
                // Slower impact = Higher multiplier (2.0 / impact). 
                // Speed 0.5 => 4x. Speed 1.9 => 1.05x. Cap multiplier at 10x.
                let speedMult = Math.min(10, 2.0 / Math.max(0.1, ship.vy));
                // Time factor: Fuel remaining is a good proxy for efficiency
                let score = Math.floor(ship.fuel * 10 * speedMult);
                
                updatePilotHighScore(score);
                
                ctx.fillStyle = "var(--success)"; 
                ctx.font = "30px sans-serif"; ctx.textAlign = "center";
                ctx.fillText("SUCCESS!", W/2, 180);
                
                ctx.font = "20px monospace";
                ctx.fillText(`Score: ${score}`, W/2, 210);
                ctx.fillText(`Speed: ${ship.vy.toFixed(2)} m/s`, W/2, 235);
            } else {
                ctx.fillStyle = "var(--accent)"; 
                ctx.font = "30px sans-serif"; ctx.textAlign = "center";
                ctx.fillText("CRASH!", W/2, 200);
            }
            setTimeout(resetGame, 3000);
        } else if (ship.y < 0) { ship.y = 0; ship.vy = 0; }

        requestAnimationFrame(gameLoop);
    }

    /* --- ENGINEER MODE --- */
    function checkEngineer() {
        const ans = parseFloat(document.getElementById('eng-input').value);
        const correct = 100 * currentGravity;
        if(ans >= correct - 1 && ans <= correct + 1) {
            document.getElementById('eng-msg').innerHTML = "<span style='color:var(--success)'>CORRECT!</span>";
        } else {
            document.getElementById('eng-msg').innerHTML = `<span style='color:var(--accent)'>Incorrect. Formula: 100 x ${currentGravity}</span>`;
        }
    }

    /* --- PHYSICIST MODE (Rigorous Suicide Burn) --- */
    const simCvs = document.getElementById('simCanvas');
    const sCtx = simCvs.getContext('2d');
    
    // Internal state for Physicist tab
    let sim = { active: false, y: 0, vy: 0, burnAlt: 0, inputAlt: 0, maxViewH: 1000 };
    let theory = { possible: false, aNet: 0, h: 0, t: 0 };

    function setRocket(r) {
        currentRocket = rocketData[r];
        document.querySelectorAll('.rocket-selector .p-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updatePhysicistUI();
    }

    function calculateTheory() {
        const p = planetData[currentPlanet];
        const r = currentRocket;
        
        const weight = r.mass * p.g;
        const netForce = r.thrust - weight; // Upward force
        
        if (netForce <= 0) {
            return { possible: false, aNet: 0, h: 0, t: 0 };
        }
        
        const aNet = netForce / r.mass; // Upward acceleration
        const t = p.v / aNet;           // Time to stop from v0
        const h = (p.v * p.v) / (2 * aNet); // Distance to stop
        
        return { possible: true, aNet: aNet, h: h, t: t };
    }

    function updatePhysicistUI() {
        // UI Text
        document.getElementById('phy-m').innerText = currentRocket.mass;
        document.getElementById('phy-t').innerText = currentRocket.thrust;
        document.getElementById('phy-v').innerText = planetData[currentPlanet].v;
        
        // Logic
        theory = calculateTheory();
        const statusEl = document.getElementById('phy-status');
        const btn = document.getElementById('sim-btn');
        const inp = document.getElementById('phys-input');
        
        if(!theory.possible) {
            statusEl.innerText = "IMPOSSIBLE: Thrust < Weight. Cannot decelerate.";
            statusEl.style.color = "var(--accent)";
            btn.disabled = true;
            inp.disabled = true;
            // Clear canvas
            sCtx.clearRect(0,0,simCvs.width, simCvs.height);
        } else {
            statusEl.innerText = "SYSTEM READY: Calculate Suicide Burn Altitude.";
            statusEl.style.color = "var(--success)";
            btn.disabled = false;
            inp.disabled = false;
        }
    }

    function initSimCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = simCvs.getBoundingClientRect();
        simCvs.width = rect.width * dpr;
        simCvs.height = 400 * dpr;
        sCtx.scale(dpr, dpr);
    }

    function toggleHint() { document.getElementById('math-hint').style.display = 'block'; }

    function runSimulation() {
        if(!theory.possible) return;
        
        const inputVal = parseFloat(document.getElementById('phys-input').value);
        if(isNaN(inputVal) || inputVal <= 0) {
            alert("Please enter a valid altitude.");
            return;
        }

        sim.inputAlt = inputVal;
        
        // Setup Simulation State
        // Model: Start at inputAlt with downward velocity v0. Engines FULL immediately.
        sim.y = inputVal;
        sim.vy = planetData[currentPlanet].v; 
        
        sim.active = true;
        
        // Set View Scale: View height should cover the start altitude + some padding
        sim.maxViewH = Math.max(inputVal * 1.2, 100);

        simLoop();
    }

    function simLoop() {
        if(!sim.active) return;
        
        // Time Step (Accelerated time for usability)
        // Earth burn takes 10 mins real time. We want it in ~5-10 seconds.
        // Let's use a fairly coarse dt for visual speed
        const dt = 0.1; // 100ms per frame effective physics step
        
        // Physics (Constant Deceleration)
        // vy is downward speed. aNet is upward acceleration.
        // vy_new = vy_old - aNet * dt
        sim.vy -= (theory.aNet * dt);
        sim.y -= (sim.vy * dt);

        // Visuals
        const W = simCvs.width / (window.devicePixelRatio||1);
        const H = 400;
        sCtx.fillStyle = "#000"; sCtx.fillRect(0,0,W,H);

        // Map Height to Y pixels (0 at bottom, maxViewH at top)
        function mapY(meters) { 
            return H - (meters / sim.maxViewH * H); 
        }

        // Ruler
        sCtx.fillStyle = "#444"; sCtx.font = "10px monospace";
        const step = Math.pow(10, Math.floor(Math.log10(sim.maxViewH))); // Dynamic step size
        for(let i=0; i<=sim.maxViewH; i+=step) {
            const yy = mapY(i);
            if(yy < 0) continue;
            sCtx.fillRect(0, yy, 20, 1);
            sCtx.fillText(i+"m", 25, yy+4);
        }

        // Ground
        sCtx.fillStyle = planetData[currentPlanet].color;
        sCtx.fillRect(0, H-10, W, 10);

        // Rocket
        const rocketY = mapY(sim.y);
        sCtx.save();
        sCtx.translate(W/2, rocketY);
        
        // Flame (Always on in this sim)
        sCtx.fillStyle = "orange";
        // flicker
        const hF = 20 + Math.random()*10;
        sCtx.beginPath(); sCtx.moveTo(-5, 10); sCtx.lineTo(5, 10); sCtx.lineTo(0, 10+hF); sCtx.fill();
        
        // Body
        sCtx.fillStyle = "white";
        if(currentRocket.type === 'tri') {
            sCtx.beginPath(); sCtx.moveTo(0, -10); sCtx.lineTo(10, 10); sCtx.lineTo(-10, 10); sCtx.fill();
        } else if (currentRocket.type === 'squ') {
            sCtx.fillRect(-10, 0, 20, 15);
            sCtx.beginPath(); sCtx.moveTo(-10, 0); sCtx.lineTo(10, 0); sCtx.lineTo(0, -15); sCtx.fill();
        } else {
            sCtx.fillRect(-8, -5, 16, 25);
            sCtx.beginPath(); sCtx.moveTo(-8, -5); sCtx.lineTo(8, -5); sCtx.lineTo(0, -20); sCtx.fill();
        }
        sCtx.restore();

        // Info Overlay
        sCtx.fillStyle = "white"; sCtx.font="14px monospace";
        sCtx.fillText(`Alt: ${Math.max(0, sim.y).toFixed(1)} m`, W-150, 20);
        sCtx.fillText(`Vel: ${sim.vy.toFixed(1)} m/s (Down)`, W-150, 40);

        // End Conditions
        if(sim.y <= 0) {
            sim.active = false;
            // Impact check - 5m/s tolerance
            if(sim.vy > 5.0) { 
                drawResult("CRASH (Too Late)", "var(--accent)", W, H);
            } else {
                drawResult("PERFECT LANDING", "var(--success)", W, H);
            }
        } else if (sim.vy < -2.0) { 
            // Flying upwards significantly
            sim.active = false;
            drawResult("BURNED TOO EARLY", "var(--warning)", W, H);
        }

        requestAnimationFrame(simLoop);
    }

    function drawResult(text, color, W, H) {
        sCtx.fillStyle = color; 
        sCtx.font = "bold 30px sans-serif";
        sCtx.textAlign = "center";
        sCtx.fillText(text, W/2, H/2);
    }
</script>
</body>
</html>